package com.atasoyh.appbusinesstestproject.ui.comics;


import android.app.Instrumentation;
import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;
import android.support.test.InstrumentationRegistry;
import android.support.test.espresso.Espresso;
import android.support.test.espresso.IdlingPolicies;
import android.support.test.espresso.IdlingResource;
import android.support.test.espresso.ViewInteraction;
import android.support.test.espresso.contrib.RecyclerViewActions;
import android.support.test.espresso.idling.CountingIdlingResource;
import android.support.test.rule.ActivityTestRule;
import android.support.test.runner.AndroidJUnit4;
import android.test.suitebuilder.annotation.LargeTest;
import android.util.Log;
import android.view.View;
import android.view.ViewGroup;
import android.view.ViewParent;

import com.atasoyh.appbusinesstestproject.DefaultApplication;
import com.atasoyh.appbusinesstestproject.R;
import com.atasoyh.appbusinesstestproject.RxEspresso;
import com.atasoyh.appbusinesstestproject.RxEspressoTransformer;
import com.atasoyh.appbusinesstestproject.interactor.api.MarvelApi;
import com.atasoyh.appbusinesstestproject.model.ComicResponse;
import com.atasoyh.appbusinesstestproject.presenter.comics.di.component.TestComponent;
import com.atasoyh.appbusinesstestproject.ui.comicdetail.ComicDetailActivity;
import com.google.gson.Gson;

import org.hamcrest.Description;
import org.hamcrest.Matcher;
import org.hamcrest.TypeSafeMatcher;
import org.hamcrest.core.IsInstanceOf;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Rule;
import org.junit.Test;
import org.junit.runner.RunWith;

import java.util.concurrent.TimeUnit;

import javax.inject.Inject;

import io.reactivex.Observable;
import io.reactivex.android.plugins.RxAndroidPlugins;
import io.reactivex.schedulers.Schedulers;

import static android.support.test.espresso.Espresso.onView;
import static android.support.test.espresso.action.ViewActions.click;
import static android.support.test.espresso.assertion.ViewAssertions.matches;
import static android.support.test.espresso.contrib.RecyclerViewActions.actionOnItemAtPosition;
import static android.support.test.espresso.matcher.ViewMatchers.isDisplayed;
import static android.support.test.espresso.matcher.ViewMatchers.withId;
import static android.support.test.espresso.matcher.ViewMatchers.withTagValue;
import static android.support.test.espresso.matcher.ViewMatchers.withText;
import static org.hamcrest.Matchers.allOf;
import static org.hamcrest.Matchers.is;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyInt;
import static org.mockito.Mockito.when;

@LargeTest
@RunWith(AndroidJUnit4.class)
public class ComicListActivityTest {

    String mockComicsResponse = "{\"code\":200,\"status\":\"Ok\",\"copyright\":\"© 2017 MARVEL\",\"attributionText\":\"Data provided by Marvel. © 2017 MARVEL\",\"attributionHTML\":\"<a href=\\\"http://marvel.com\\\">Data provided by Marvel. © 2017 MARVEL</a>\",\"etag\":\"080fd445aeb340ec55361a003b87f4731d4d90fe\",\"data\":{\"offset\":0,\"limit\":10,\"total\":39962,\"count\":10,\"results\":[{\"id\":58584,\"digitalId\":0,\"title\":\"Amazing Spider-Man (2015) #16 (Jimenez Black Panther 50th Anniversary Variant)\",\"issueNumber\":16,\"variantDescription\":\"Jimenez Black Panther 50th Anniversary Variant\",\"description\":null,\"modified\":\"2016-07-25T16:07:36-0400\",\"isbn\":\"\",\"upc\":\"75960608297101621\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":32,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/58584\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/58584/amazing_spider-man_2015_16_jimenez_black_panther_50th_anniversary_variant/jimenez_black_panther_50th_anniversary_variant?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/20432\",\"name\":\"Amazing Spider-Man (2015 - Present)\"},\"variants\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/55314\",\"name\":\"Amazing Spider-Man (2015) #16\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/60197\",\"name\":\"Amazing Spider-Man (2015) #16 (Samnee Marvel Tsum Tsum Takeover Variant)\"}],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"2016-07-20T00:00:00-0400\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":3.99}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/58584/creators\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/12451\",\"name\":\"Jorge Jiminez\",\"role\":\"penciller (cover)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/4300\",\"name\":\"Nick Lowe\",\"role\":\"editor\"}],\"returned\":2},\"characters\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/58584/characters\",\"items\":[],\"returned\":0},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/58584/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/127768\",\"name\":\"cover from The Amazing Spider-Man (2015) #16 (TBD ARTIST BLACK PANTHER 50TH ANNIVERSARY VARIANT)\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/127769\",\"name\":\"story from The Amazing Spider-Man (2015) #16 (TBD ARTIST BLACK PANTHER 50TH ANNIVERSARY VARIANT)\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/58584/events\",\"items\":[],\"returned\":0}},{\"id\":60017,\"digitalId\":0,\"title\":\"Amazing Spider-Man (2015) #24 (Lozano Teaser Variant)\",\"issueNumber\":24,\"variantDescription\":\"Lozano Teaser Variant\",\"description\":null,\"modified\":\"2017-02-15T10:21:16-0500\",\"isbn\":\"\",\"upc\":\"75960608297102421\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":32,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/60017\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/60017/amazing_spider-man_2015_24_lozano_teaser_variant/lozano_teaser_variant?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/20432\",\"name\":\"Amazing Spider-Man (2015 - Present)\"},\"variants\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/55322\",\"name\":\"Amazing Spider-Man (2015) #24\"}],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"2017-01-18T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":3.99}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/60017/creators\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/4300\",\"name\":\"Nick Lowe\",\"role\":\"editor\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/12373\",\"name\":\"Alexander Lozano\",\"role\":\"penciller (cover)\"}],\"returned\":2},\"characters\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/60017/characters\",\"items\":[],\"returned\":0},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/60017/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/130568\",\"name\":\"cover from Amazing Spider-Man (2015) #24 (LOZANO TEASER VARIANT)\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/130569\",\"name\":\"story from Amazing Spider-Man (2015) #24 (LOZANO TEASER VARIANT)\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/60017/events\",\"items\":[],\"returned\":0}},{\"id\":23561,\"digitalId\":0,\"title\":\"Holiday Special (1969) #1\",\"issueNumber\":1,\"variantDescription\":\"\",\"description\":null,\"modified\":\"-0001-11-30T00:00:00-0500\",\"isbn\":\"\",\"upc\":\"\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":0,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/23561\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/23561/holiday_special_1969_1?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/6700\",\"name\":\"Holiday Special (1969)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":0}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/23561/creators\",\"items\":[],\"returned\":0},\"characters\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/23561/characters\",\"items\":[],\"returned\":0},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/23561/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/52600\",\"name\":\"Cover #52600\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/52601\",\"name\":\"Interior #52601\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/23561/events\",\"items\":[],\"returned\":0}},{\"id\":20956,\"digitalId\":0,\"title\":\"Penance: Relentless (2008)\",\"issueNumber\":0,\"variantDescription\":\"\",\"description\":\"From the pages of CIVIL WAR: FRONT LINE and THUNDERBOLTS! Once he was a hero, now only a shell of Robbie Baldwin remains. As Penance, he begins a slow descent into madness: the most hated man in America, blamed for the disaster at Stamford, tortured by visions of his failure and obsessed with strange, seemingly meaningless numbers. A relentless pursuit begins... Collecting PENANCE: RELENTLESS #1-5.\\r<br>Rated T+ ...$13.99\\r<br>\",\"modified\":\"-0001-11-30T00:00:00-0500\",\"isbn\":\"\",\"upc\":\"\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":0,\"textObjects\":[{\"type\":\"issue_solicit_text\",\"language\":\"en-us\",\"text\":\"From the pages of CIVIL WAR: FRONT LINE and THUNDERBOLTS! Once he was a hero, now only a shell of Robbie Baldwin remains. As Penance, he begins a slow descent into madness: the most hated man in America, blamed for the disaster at Stamford, tortured by visions of his failure and obsessed with strange, seemingly meaningless numbers. A relentless pursuit begins... Collecting PENANCE: RELENTLESS #1-5.\\r<br>Rated T+ ...$13.99\\r<br>\"}],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/20956\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/20956/penance_relentless_2008?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/4070\",\"name\":\"Penance: Relentless (2008)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":0}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/9/90/4bb860a46f58d\",\"extension\":\"jpg\"},\"images\":[{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/9/90/4bb860a46f58d\",\"extension\":\"jpg\"}],\"creators\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/20956/creators\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/222\",\"name\":\"Paul Gulacy\",\"role\":\"penciller (cover)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/55\",\"name\":\"Paul Jenkins\",\"role\":\"writer\"}],\"returned\":2},\"characters\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/20956/characters\",\"items\":[],\"returned\":0},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/20956/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/45155\",\"name\":\"Cover #45155\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/45156\",\"name\":\"Interior #45156\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/20956/events\",\"items\":[],\"returned\":0}},{\"id\":37497,\"digitalId\":0,\"title\":\"Marvels Vol. 1 (1994) #1\",\"issueNumber\":1,\"variantDescription\":\"\",\"description\":null,\"modified\":\"2014-05-08T12:18:41-0400\",\"isbn\":\"\",\"upc\":\"\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Digital Comic\",\"pageCount\":0,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/37497\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/37497/marvels_vol_1_1994_1?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/13495\",\"name\":\"Marvels Vol. 1 (1994)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":0}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/37497/creators\",\"items\":[],\"returned\":0},\"characters\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/37497/characters\",\"items\":[],\"returned\":0},\"stories\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/37497/stories\",\"items\":[],\"returned\":0},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/37497/events\",\"items\":[],\"returned\":0}},{\"id\":16244,\"digitalId\":0,\"title\":\"Cap Transport (2005) #5\",\"issueNumber\":5,\"variantDescription\":\"\",\"description\":null,\"modified\":\"-0001-11-30T00:00:00-0500\",\"isbn\":\"\",\"upc\":\"\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":0,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/16244\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/16244/cap_transport_2005_5?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/2722\",\"name\":\"Cap Transport (2005 - 2006)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":0}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":6,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/16244/creators\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/2133\",\"name\":\"Tom Brevoort\",\"role\":\"editor\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/367\",\"name\":\"Ed Brubaker\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/8504\",\"name\":\"Frank D'Armata\",\"role\":\"colorist\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/374\",\"name\":\"Steve Epting\",\"role\":\"penciler\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/509\",\"name\":\"Michael Lark\",\"role\":\"penciler\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/8635\",\"name\":\"Randy Gentile\",\"role\":\"letterer\"}],\"returned\":6},\"characters\":{\"available\":5,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/16244/characters\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009220\",\"name\":\"Captain America\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009356\",\"name\":\"Human Torch\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009471\",\"name\":\"Nick Fury\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009535\",\"name\":\"Red Skull\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1010791\",\"name\":\"Sub-Mariner\"}],\"returned\":5},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/16244/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/34015\",\"name\":\"Out of Time, Part 5\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/34016\",\"name\":\"Out of Time, Part 5\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/16244/events\",\"items\":[],\"returned\":0}},{\"id\":21481,\"digitalId\":0,\"title\":\"Ultimate X-Men (Spanish Language Edition) (2000) #4\",\"issueNumber\":4,\"variantDescription\":\"\",\"description\":null,\"modified\":\"-0001-11-30T00:00:00-0500\",\"isbn\":\"\",\"upc\":\"\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":36,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/21481\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/21481/ultimate_x-men_spanish_language_edition_2000_4?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/5106\",\"name\":\"Ultimate X-Men (Spanish Language Edition) (2000 - 2009)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":0}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21481/creators\",\"items\":[],\"returned\":0},\"characters\":{\"available\":1,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21481/characters\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1011109\",\"name\":\"X-Men (Ultimate)\"}],\"returned\":1},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21481/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/48990\",\"name\":\"Cover #48990\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/48991\",\"name\":\"Interior #48991\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21481/events\",\"items\":[],\"returned\":0}},{\"id\":21469,\"digitalId\":0,\"title\":\"Ultimate Spider-Man (Spanish Language Edition) (2000) #5\",\"issueNumber\":5,\"variantDescription\":\"\",\"description\":null,\"modified\":\"-0001-11-30T00:00:00-0500\",\"isbn\":\"\",\"upc\":\"\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":36,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/21469\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/21469/ultimate_spider-man_spanish_language_edition_2000_5?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/5105\",\"name\":\"Ultimate Spider-Man (Spanish Language Edition) (2000 - 2001)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":2.25}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21469/creators\",\"items\":[],\"returned\":0},\"characters\":{\"available\":1,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21469/characters\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1011010\",\"name\":\"Spider-Man (Ultimate)\"}],\"returned\":1},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21469/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/48966\",\"name\":\"Cover #48966\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/48967\",\"name\":\"Interior #48967\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/21469/events\",\"items\":[],\"returned\":0}},{\"id\":1886,\"digitalId\":0,\"title\":\"Official Handbook of the Marvel Universe (2004) #12 (SPIDER-MAN)\",\"issueNumber\":12,\"variantDescription\":\"SPIDER-MAN\",\"description\":\"The spectacular sequel to last year's OFFICIAL HANDBOOK OF THE MARVEL UNIVERSE: SPIDER-MAN 2004, this Official Handbook contains in-depth bios on more than 30 of the wisecracking web-slinger's closest allies and most infamous enemies - including the Stacy Twins, fresh from the pages of AMAZING SPIDER-MAN, and Toxin, in time for this month's TOXIN #1! Plus: An all-new cover by superstar artist Tom Raney, digitally painted by Morry Hollowell.\\r<br>48 PGS./Marvel PSR ...$3.99\\r<br>\",\"modified\":\"-0001-11-30T00:00:00-0500\",\"isbn\":\"\",\"upc\":\"5960605667-00111\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":0,\"textObjects\":[{\"type\":\"issue_solicit_text\",\"language\":\"en-us\",\"text\":\"The spectacular sequel to last year's OFFICIAL HANDBOOK OF THE MARVEL UNIVERSE: SPIDER-MAN 2004, this Official Handbook contains in-depth bios on more than 30 of the wisecracking web-slinger's closest allies and most infamous enemies - including the Stacy Twins, fresh from the pages of AMAZING SPIDER-MAN, and Toxin, in time for this month's TOXIN #1! Plus: An all-new cover by superstar artist Tom Raney, digitally painted by Morry Hollowell.\\r<br>48 PGS./Marvel PSR ...$3.99\\r<br>\"}],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/1886\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/1886/official_handbook_of_the_marvel_universe_2004_12_spider-man/spider-man?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/787\",\"name\":\"Official Handbook of the Marvel Universe (2004)\"},\"variants\":[],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"-0001-11-30T00:00:00-0500\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":3.99}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/4bc64020a4ccc\",\"extension\":\"jpg\"},\"images\":[{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/4bc64020a4ccc\",\"extension\":\"jpg\"}],\"creators\":{\"available\":12,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/1886/creators\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/907\",\"name\":\"Heather Buchanan\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/887\",\"name\":\"Ronald Byrd\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/902\",\"name\":\"Jeff Christiansen\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/909\",\"name\":\"Eric Engelhard\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/906\",\"name\":\"Mike Fichera\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/910\",\"name\":\"Jason Godin\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/897\",\"name\":\"Sean McQuaid\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/900\",\"name\":\"Barry Reese\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/905\",\"name\":\"Al Sjoerdsma\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/911\",\"name\":\"Bryan Thiessen\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/908\",\"name\":\"Kerry Wilkinson\",\"role\":\"writer\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/444\",\"name\":\"Tom Raney\",\"role\":\"penciller (cover)\"}],\"returned\":12},\"characters\":{\"available\":14,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/1886/characters\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009156\",\"name\":\"Apocalypse\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009197\",\"name\":\"Blink\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009243\",\"name\":\"Colossus\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009313\",\"name\":\"Gambit\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009349\",\"name\":\"Holocaust (Age of Apocalypse)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009417\",\"name\":\"Magneto\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009447\",\"name\":\"Mister Sinister\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009546\",\"name\":\"Rogue\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1010969\",\"name\":\"Sabretooth (Age of Apocalypse)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1010975\",\"name\":\"Shadowcat (Age of Apocalypse)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1010976\",\"name\":\"Silver Samurai (Age of Apocalypse)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1010979\",\"name\":\"Storm (Age of Apocalypse)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009636\",\"name\":\"Sunfire\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/characters/1009718\",\"name\":\"Wolverine\"}],\"returned\":14},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/1886/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/4430\",\"name\":\"Cover #4430\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/4431\",\"name\":\"Interior #4431\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/1886/events\",\"items\":[],\"returned\":0}},{\"id\":59181,\"digitalId\":0,\"title\":\"Civil War II (2016) #6 (Gi Connecting Variant H)\",\"issueNumber\":6,\"variantDescription\":\"Gi Connecting Variant H\",\"description\":null,\"modified\":\"2016-08-30T11:04:03-0400\",\"isbn\":\"\",\"upc\":\"75960608471500641\",\"diamondCode\":\"\",\"ean\":\"\",\"issn\":\"\",\"format\":\"Comic\",\"pageCount\":40,\"textObjects\":[],\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/59181\",\"urls\":[{\"type\":\"detail\",\"url\":\"http://marvel.com/comics/issue/59181/civil_war_ii_2016_6_gi_connecting_variant_h/gi_connecting_variant_h?utm_campaign=apiRef&utm_source=18d148ca86bd623d2b2b9acdc736e034\"}],\"series\":{\"resourceURI\":\"http://gateway.marvel.com/v1/public/series/21417\",\"name\":\"Civil War II (2016 - Present)\"},\"variants\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/59754\",\"name\":\"Civil War II (2016) #6 (Sprouse Battle Variant)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/58683\",\"name\":\"Civil War II (2016) #6\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/58879\",\"name\":\"Civil War II (2016) #6 (Michael Cho Variant)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/59180\",\"name\":\"Civil War II (2016) #6 (Gi B&W Virgin Connecting Variant G)\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/comics/59454\",\"name\":\"Civil War II (2016) #6 (Noto Black Panther Variant)\"}],\"collections\":[],\"collectedIssues\":[],\"dates\":[{\"type\":\"onsaleDate\",\"date\":\"2029-12-31T00:00:00-0500\"},{\"type\":\"focDate\",\"date\":\"2016-08-24T00:00:00-0400\"}],\"prices\":[{\"type\":\"printPrice\",\"price\":4.99}],\"thumbnail\":{\"path\":\"http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available\",\"extension\":\"jpg\"},\"images\":[],\"creators\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/59181/creators\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/2133\",\"name\":\"Tom Brevoort\",\"role\":\"editor\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/creators/12853\",\"name\":\"Jung Gi Kim\",\"role\":\"penciller (cover)\"}],\"returned\":2},\"characters\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/59181/characters\",\"items\":[],\"returned\":0},\"stories\":{\"available\":2,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/59181/stories\",\"items\":[{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/128895\",\"name\":\"cover from Cw2 (2016) #6 (GI CONNECTING VARIANT H)\",\"type\":\"cover\"},{\"resourceURI\":\"http://gateway.marvel.com/v1/public/stories/128896\",\"name\":\"story from Cw2 (2016) #6 (GI CONNECTING VARIANT H)\",\"type\":\"interiorStory\"}],\"returned\":2},\"events\":{\"available\":0,\"collectionURI\":\"http://gateway.marvel.com/v1/public/comics/59181/events\",\"items\":[],\"returned\":0}}]}}";

    IdlingResource idlingResource;

    @Rule
    public ActivityTestRule<ComicListActivity> mActivityTestRule = new ActivityTestRule<>(ComicListActivity.class, false, false);

    @Before
    public void setUp() {
        setUpInjection();
        mockResponse();
        launchActivity();
        RxAndroidPlugins.setInitMainThreadSchedulerHandler(__ -> Schedulers.trampoline());
        setUpIdlingResource();
    }


    @Inject
    MarvelApi marvelApi;

    @Inject
    Gson gson;

    @Inject
    RxEspressoTransformer rxEspressoTransformer;

    private void setUpInjection() {
        Instrumentation instrumentation = InstrumentationRegistry.getInstrumentation();
        DefaultApplication app
                = (DefaultApplication) instrumentation.getTargetContext().getApplicationContext();
        TestComponent component = (TestComponent) app.appComponent;
        component.inject(this);
    }

    private void mockResponse() {
        ComicResponse response = gson.fromJson(mockComicsResponse, ComicResponse.class);
        when(marvelApi.getComics(anyInt(), anyInt())).thenReturn(Observable.defer(() -> Observable.just(response).delay(1, TimeUnit.SECONDS).compose(rxEspressoTransformer.apply())));
    }

    private void launchActivity() {
        Intent i = new Intent();
        mActivityTestRule.launchActivity(i);
    }


    private void setUpIdlingResource() {
        idlingResource = new CountingIdlingResource(RxEspresso.TAG);
        Espresso.registerIdlingResources(idlingResource);
    }

    @Test
    public void IsComicListActivityOpenedTest() {

        onView(
                allOf(
                        childAtPosition(
                                allOf(withId(R.id.action_bar),
                                        childAtPosition(
                                                withId(R.id.action_bar_container),
                                                0)),
                                0),
                        isDisplayed())).check(matches(withText("Top 100 Comics")));

    }


    @Test
    public void isComicListShowingTest() {
        onView(allOf(withId(R.id.rv))).check(matches(isDisplayed()));
    }

    private static Matcher<View> childAtPosition(
            final Matcher<View> parentMatcher, final int position) {

        return new TypeSafeMatcher<View>() {
            @Override
            public void describeTo(Description description) {
                description.appendText("Child at position " + position + " in parent ");
                parentMatcher.describeTo(description);
            }

            @Override
            public boolean matchesSafely(View view) {
                ViewParent parent = view.getParent();
                return parent instanceof ViewGroup && parentMatcher.matches(parent)
                        && view.equals(((ViewGroup) parent).getChildAt(position));
            }
        };
    }


    @After
    public void unregisterIntentServiceIdlingResource() {
        Espresso.unregisterIdlingResources(idlingResource);
    }

    @AfterClass
    public static void tearDownClass() {
        RxAndroidPlugins.reset();
    }
}
